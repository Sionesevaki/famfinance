services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: famfinance
      POSTGRES_PASSWORD: famfinance
      POSTGRES_DB: famfinance
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data

  redis:
    image: redis:7
    ports:
      - "6379:6379"

  minio:
    image: minio/minio:latest
    command: ["server", "/data", "--console-address", ":9001"]
    environment:
      MINIO_ROOT_USER: minio
      MINIO_ROOT_PASSWORD: minio123
    ports:
      - "9000:9000"
      - "9001:9001"
    volumes:
      - minio_data:/data

  keycloak:
    image: quay.io/keycloak/keycloak:26.0
    command:
      - start-dev
      - --import-realm
    environment:
      KEYCLOAK_ADMIN: admin
      KEYCLOAK_ADMIN_PASSWORD: admin
    ports:
      - "8080:8080"
    volumes:
      - ./keycloak/realm-export.json:/opt/keycloak/data/import/realm-export.json:ro

  api:
    build:
      context: ../../
      dockerfile: apps/api/Dockerfile
    environment:
      NODE_ENV: development
      PORT: "4000"
      DATABASE_URL: postgresql://famfinance:famfinance@postgres:5432/famfinance
      REDIS_URL: redis://redis:6379
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minio
      S3_SECRET_KEY: minio123
      S3_BUCKET: famfinance
      TOKEN_ENCRYPTION_KEY: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
      KEYCLOAK_ISSUER: http://keycloak:8080/realms/family-finance
      KEYCLOAK_JWKS_URI: http://keycloak:8080/realms/family-finance/protocol/openid-connect/certs
      KEYCLOAK_AUDIENCE: api
    ports:
      - "4000:4000"
    depends_on:
      - postgres
      - redis
      - minio
      - keycloak

  worker:
    build:
      context: ../../
      dockerfile: apps/worker/Dockerfile
    environment:
      NODE_ENV: development
      DATABASE_URL: postgresql://famfinance:famfinance@postgres:5432/famfinance
      REDIS_URL: redis://redis:6379
      S3_ENDPOINT: http://minio:9000
      S3_ACCESS_KEY: minio
      S3_SECRET_KEY: minio123
      S3_BUCKET: famfinance
      TOKEN_ENCRYPTION_KEY: AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=
    depends_on:
      - postgres
      - redis
      - minio

volumes:
  postgres_data:
  minio_data:
